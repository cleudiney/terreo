<!-- avisos.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">

  <title>Avisos do Sistema</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/avisos.css">

  <!-- DATA CONFIG -->
  <script>
    window.DATA_CONFIG = {
      type: 'avisos',
      file: 'avisos.dat',
      target: '#listaAvisos'
    };
  </script>
</head>

<body class="bg-light fade-in">

  <!-- NAVBAR -->
  <div id="navbar"></div>

  <main class="container mt-4">
    <div class="alert alert-danger fw-bold text-center" role="alert">
      Desconsiderar dados dos dias anteriores a 20/02/2026; considerar estatisticas apenas apos 10 de marco de 2026.
    </div>

    <h2 class="mb-4 text-center">
      ‚ö†Ô∏è Avisos e Eventos do Sistema
    </h2>

    <!-- Filtros -->
    <div class="card mb-4">
      <div class="card-body row g-3">

        <div class="col-md-4">
          <label class="form-label">Tipo</label>
          <select id="filtroTipo" class="form-select">
            <option value="">Todos</option>
            <option value="critico">Cr√≠tico</option>
            <option value="urgente">Urgente</option>
            <option value="resolvido">Resolvido</option>
            <option value="controle">Controle</option>
            <option value="evento">Evento</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Buscar texto</label>
          <input
            type="text"
            id="filtroTexto"
            class="form-control"
            placeholder="Ex: bomba, vaz√£o, n√≠vel">
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
            Filtrar
          </button>
        </div>

      </div>
    </div>

    <!-- Lista -->
    <div id="listaAvisos">
      <div class="text-center text-muted">
        Carregando avisos...
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">Distribuicao por Tipo</div>
      <div class="card-body">
        <canvas id="graficoAvisos" height="100"></canvas>
      </div>
    </div>

  </main>

  <!-- JS -->
  <script src="/js/jquery-3.7.1.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/chart.min.js"></script>

  <!-- Seguran√ßa -->
  <script src="/js/auth-guard.js"></script>
  <script>
    protegerPagina(['admin','sindico','subsindico','zelador']);
  </script>

  <!-- Navbar -->
  <script src="/js/navbar.js"></script>

  <!-- Loader -->
  <script src="/js/data-loader.js"></script>

  <!-- Filtros -->
  <script>
    let avisos = [];
    let graficoAvisos = null;

    dataLoader.afterLoad = function(dados) {
      avisos = dados || [];
      renderizarAvisos(avisos);
      atualizarGraficoAvisos(avisos);
    };

    function renderizarAvisos(lista) {
      const container = document.getElementById('listaAvisos');
      container.innerHTML = '';

      if (!lista.length) {
        container.innerHTML =
          '<div class="alert alert-info text-center">Nenhum aviso registrado.</div>';
        return;
      }

      lista.forEach(a => {
        const div = document.createElement('div');
        div.className = `aviso ${a.tipo || 'evento'}`;

        div.innerHTML = `
          <div class="d-flex justify-content-between">
            <strong>${a.mensagem}</strong>
            <span class="badge bg-secondary">
              ${(a.tipo || 'evento').toUpperCase()}
            </span>
          </div>
          <small>
            üïí ${a.data}
            ${a.usuario ? ' | üë§ ' + a.usuario : ''}
          </small>
        `;

        container.appendChild(div);
      });
    }

    function aplicarFiltros() {
      const tipo = document.getElementById('filtroTipo').value;
      const texto = document.getElementById('filtroTexto').value.toLowerCase();

      const filtrados = avisos.filter(a => {
        if (tipo && a.tipo !== tipo) return false;
        if (texto && !a.mensagem.toLowerCase().includes(texto)) return false;
        return true;
      });

      renderizarAvisos(filtrados);
      atualizarGraficoAvisos(filtrados);
    }

    function atualizarGraficoAvisos(lista) {
      if (typeof Chart === 'undefined') return;
      const canvas = document.getElementById('graficoAvisos');
      if (!canvas) return;

      const cont = { critico: 0, urgente: 0, resolvido: 0, evento: 0, controle: 0 };
      lista.forEach(a => {
        const t = (a.tipo || 'evento').toLowerCase();
        if (typeof cont[t] === 'number') cont[t]++;
      });

      const labels = ['Critico', 'Urgente', 'Resolvido', 'Evento', 'Controle'];
      const data = [cont.critico, cont.urgente, cont.resolvido, cont.evento, cont.controle];

      if (graficoAvisos) graficoAvisos.destroy();
      graficoAvisos = new Chart(canvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Quantidade',
            data
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }
  </script>

</body>
</html>
