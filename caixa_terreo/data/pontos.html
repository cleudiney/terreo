<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Pontos do Dia - Caixa d'Ãgua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/pontos.css">

  <!-- DATA CONFIG -->
  <script>
    window.DATA_CONFIG = {
      type: 'pontos',
      file: 'pontos.dat',
      target: '#conteudo'
    };
  </script>
</head>

<body class="bg-light fade-in">

<!-- NAVBAR -->
<div id="navbar"></div>

<main class="container mt-4">

  <h2 class="text-center mb-4">
    <i class="bi bi-calendar-day"></i>
    Pontos de MediÃ§Ã£o do Dia
  </h2>

  <!-- CONTEÃšDO -->
  <div id="conteudo">
    <div class="loading">
      Carregando pontos do dia...
    </div>
  </div>

  <!-- GRÃFICO -->
  <div class="card mt-4">
    <div class="card-header">
      <i class="bi bi-graph-up"></i> EvoluÃ§Ã£o do NÃ­vel
    </div>
    <div class="card-body">
      <canvas id="graficoNivel" height="110"></canvas>
    </div>
  </div>

</main>

<!-- JS base -->
<script src="/js/jquery-3.7.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script>
  function loadChartFromCDN() {
    if (window.Chart) return;
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
    s.defer = true;
    document.head.appendChild(s);
  }
</script>
<script src="/js/chart.min.js" onerror="loadChartFromCDN()"></script>

<!-- SeguranÃ§a -->
<script src="/js/auth-guard.js"></script>
<script>
  protegerPagina(['admin','sindico','subsindico','zelador']);
</script>

<!-- Navbar -->
<script src="/js/navbar.js"></script>

<!-- Loader -->
<script src="/js/data-loader.js"></script>

<!-- Script da pÃ¡gina -->
<script>
let grafico = null;

dataLoader.afterLoad = function(pontos) {

  if (!Array.isArray(pontos) || pontos.length === 0) {
    return;
  }

  // ========= tabela =========
  const container = document.getElementById('conteudo');

  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-sm align-middle">
        <thead>
          <tr>
            <th>Hora</th>
            <th>NÃ­vel (%)</th>
            <th>VazÃ£o</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;

  pontos.forEach(p => {
    html += `
      <tr>
        <td>${p.hora || ''}</td>
        <td>${p.nivel ?? ''}</td>
        <td>${p.vazao ?? ''}</td>
        <td>${p.status || ''}</td>
      </tr>
    `;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;

  // ========= grÃ¡fico =========
  if (typeof Chart === 'undefined') {
    const cardBody = document.querySelector('#graficoNivel')?.parentElement;
    if (cardBody) {
      cardBody.innerHTML = `
        <div class="alert alert-warning mb-0">
          Grafico indisponivel: biblioteca Chart.js nao carregada.
        </div>
      `;
    }
    return;
  }

  const labels = pontos.map(p => p.hora);
  const niveis = pontos.map(p => p.nivel);

  const ctx = document.getElementById('graficoNivel');

  if (grafico) {
    grafico.destroy();
  }

  grafico = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'NÃ­vel da Caixa (%)',
        data: niveis,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: {
          min: 0,
          max: 100,
          ticks: {
            callback: v => v + '%'
          }
        }
      }
    }
  });
};
</script>

</body>
</html>

