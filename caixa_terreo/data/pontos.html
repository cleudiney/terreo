<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Pontos do Dia - Caixa d'Água</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/pontos.css">

  <!-- DATA CONFIG -->
  <script>
    window.DATA_CONFIG = {
      type: 'pontos',
      file: 'pontos.dat',
      target: '#conteudo'
    };
  </script>
</head>

<body class="bg-light fade-in">

<!-- NAVBAR -->
<div id="navbar"></div>

<main class="container mt-4">

  <h2 class="text-center mb-4">
    <i class="bi bi-calendar-day"></i>
    Pontos de Medição do Dia
  </h2>

  <!-- CONTEÚDO -->
  <div id="conteudo">
    <div class="loading">
      Carregando pontos do dia...
    </div>
  </div>

  <!-- GRÁFICO -->
  <div class="card mt-4">
    <div class="card-header">
      <i class="bi bi-graph-up"></i> Evolução do Nível
    </div>
    <div class="card-body">
      <canvas id="graficoNivel" height="110"></canvas>
    </div>
  </div>

</main>

<!-- JS base -->
<script src="/js/jquery-3.7.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/chart.min.js"></script>

<!-- Segurança -->
<script src="/js/auth-guard.js"></script>
<script>
  protegerPagina(['admin','sindico','operador']);
</script>

<!-- Navbar -->
<script src="/js/navbar.js"></script>

<!-- Loader -->
<script src="/js/data-loader.js"></script>

<!-- Script da página -->
<script>
let grafico = null;

dataLoader.afterLoad = function(pontos) {

  if (!Array.isArray(pontos) || pontos.length === 0) {
    return;
  }

  // ========= tabela =========
  const container = document.getElementById('conteudo');

  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-sm align-middle">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Nível (%)</th>
            <th>Vazão</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;

  pontos.forEach(p => {
    html += `
      <tr>
        <td>${p.hora || ''}</td>
        <td>${p.nivel ?? ''}</td>
        <td>${p.vazao ?? ''}</td>
        <td>${p.status || ''}</td>
      </tr>
    `;
  });

  html += `</tbody></table></div>`;
  container.innerHTML = html;

  // ========= gráfico =========
  const labels = pontos.map(p => p.hora);
  const niveis = pontos.map(p => p.nivel);

  const ctx = document.getElementById('graficoNivel');

  if (grafico) {
    grafico.destroy();
  }

  grafico = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Nível da Caixa (%)',
        data: niveis,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: {
          min: 0,
          max: 100,
          ticks: {
            callback: v => v + '%'
          }
        }
      }
    }
  });
};
</script>

</body>
</html>
